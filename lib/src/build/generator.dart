import 'dart:io';
import 'package:path/path.dart' as path;
import '../module_repository.dart';
import 'provider_parser.dart';

/// Code generator for auto-discovering and registering module providers
class ModuleCodeGenerator {
  final String projectRoot;
  final String outputPath;
  final ModuleRepository repository;

  ModuleCodeGenerator({
    required this.projectRoot,
    String? outputPath,
    ModuleRepository? repository,
    String? localModulesPath,
  })  : outputPath =
            outputPath ?? path.join(projectRoot, 'lib', 'app', 'modules.dart'),
        repository = repository ??
            ModuleRepository(
              // Use provided path or check both 'packages' and 'modules' directories
              localModulesPath: localModulesPath,
            );

  /// Generate the modules.dart file with auto-registration code
  Future<void> generate() async {
    // Scan all modules
    final modules = repository.scan();

    // Filter to only enabled modules
    final enabledModules = modules.where((m) => m.enabled).toList();

    // Collect all unique imports
    final imports = <String>{};
    final registrations = <Map<String, String>>[];

    for (final module in enabledModules) {
      for (final providerClass in module.providers) {
        try {
          final parsed = ProviderParser.parse(providerClass);
          imports.add(parsed['import']!);
          registrations.add({
            'class': providerClass,
            'className': parsed['className']!,
            'import': parsed['import']!,
          });
        } catch (e) {
          print(
              'Warning: Skipping invalid provider "$providerClass" in module "${module.name}": $e');
        }
      }
    }

    // Generate the Dart code
    final code = _generateCode(imports.toList()..sort(), registrations);

    // Write to file
    final file = File(outputPath);
    file.createSync(recursive: true);
    file.writeAsStringSync(code);

    print('Generated: $outputPath');
    print(
        'Registered ${registrations.length} providers from ${enabledModules.length} modules');
  }

  /// Generate Dart code for module registration
  String _generateCode(
      List<String> imports, List<Map<String, String>> registrations) {
    final buffer = StringBuffer();

    // Header comment
    buffer
        .writeln('// Auto-generated by modular_flutter - DO NOT EDIT MANUALLY');
    buffer.writeln('// Run `dart run modular_flutter build` to regenerate');
    buffer.writeln('');

    // Imports
    buffer.writeln("import 'package:modular_flutter/modular_flutter.dart';");
    for (final import in imports) {
      buffer.writeln("import '$import';");
    }
    buffer.writeln('');

    // Registration function
    buffer.writeln('/// Auto-register all enabled modules and their providers');
    buffer.writeln('void registerAllModules(ModuleRegistry registry) {');
    buffer.writeln('  final modules = registry.repository.all();');
    buffer.writeln('  ');
    buffer.writeln('  for (final module in modules) {');
    buffer.writeln('    if (!module.enabled) continue;');
    buffer.writeln('    ');
    buffer.writeln('    // Auto-register providers from module.yaml');
    buffer.writeln('    for (final providerClass in module.providers) {');
    buffer.writeln('      switch (providerClass) {');

    // Generate switch cases
    for (final reg in registrations) {
      final className = reg['className']!;
      final providerClass = reg['class']!;
      buffer.writeln("        case '$providerClass':");
      buffer.writeln('          registry.registerProviderFactory(');
      buffer.writeln("            '$providerClass',");
      buffer.writeln('            (module) => $className(module),');
      buffer.writeln('          );');
      buffer.writeln('          break;');
    }

    buffer.writeln('        default:');
    buffer.writeln('          // Provider not found in generated code');
    buffer.writeln('          break;');
    buffer.writeln('      }');
    buffer.writeln('    }');
    buffer.writeln('  }');
    buffer.writeln('}');

    return buffer.toString();
  }
}
